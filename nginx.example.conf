# Example Nginx config for Youtube Karaoke Together
#
# How to use:
# 1) Replace `kae.zhg.au` with your domain
# 2) Set `root` to your built client directory (e.g. /var/www/<domain>)
# 3) Ensure your backend listens on the proxy_pass port (default 8080)
# 4) Configure SSL with Certbot or your preferred method
# 5) Reload Nginx: `nginx -t && systemctl reload nginx`
#
# Notes:
# - /api/ and /ws/ proxy to the backend
# - /ws/ enables WebSocket upgrades for Socket.IO

map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name kae.zhg.au;

    root /var/www/kae.zhg.au;
    index index.html;

    ssl_certificate /etc/letsencrypt/live/kae.zhg.au/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/kae.zhg.au/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location /api/ {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /ws/ {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }

    location / {
        try_files $uri $uri/ /index.html;
    }
}

server {
    listen 80;
    listen [::]:80;
    server_name kae.zhg.au;
    return 301 https://$host$request_uri;
}
